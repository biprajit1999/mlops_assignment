stages:
  - train
  - build
  - deploy

variables:
  # Defaults; override in GitLab CI/CD variables for your project
  AWS_REGION: "ap-northeast-1"
  # Provide the full ECR URI (registry/repo). We'll default to the URI you provided.
  ECR_URI: "670880232822.dkr.ecr.ap-northeast-1.amazonaws.com/mlops"

train:
  image: python:3.10-slim
  stage: train
  script:
    - python -V
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - mkdir -p models
    - python src/train.py --output models/model.pkl
  artifacts:
    paths:
      - models/model.pkl
    expire_in: 1h

build_and_push:
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  stage: build
  variables:
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache python3 py3-pip bash jq
    - pip3 install --no-cache-dir awscli
    - aws --version
  script:
    # Ensure helper is executable and run it. The helper parses ECR URI and pushes.
    - chmod +x ci/build_and_push.sh
    - ECR_URI="$ECR_URI" AWS_REGION="$AWS_REGION" AWS_ACCOUNT_ID="$AWS_ACCOUNT_ID" ./ci/build_and_push.sh
  dependencies:
    - train
  only:
    - master

deploy_infra:
  image: hashicorp/terraform:1.5.9
  stage: deploy
  script:
    - echo "This job is manual. Configure Terraform variables in CI/CD and run apply to provision infra."
  when: manual
  only:
    - master

deploy_app:
  image: bitnami/kubectl:1.27
  stage: deploy
  script:
    - echo "Manual deploy: KUBECONFIG must be configured in CI variables (base64 or raw)."
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG" > ~/.kube/config
    - kubectl apply -f deploy/
  when: manual
  only:
    - master
